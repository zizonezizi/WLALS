<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI ë§ˆí”¼ì•„ ê²Œì„ - ì±„íŒ… ëª¨ë“œ</title>
    <style>
        :root { --bg-color: #1a1a1a; --card-bg: #2d2d2d; --text: #e0e0e0; --accent: #e74c3c; --chat-ai: #3498db; --chat-me: #f1c40f; }
        body { background-color: var(--bg-color); color: var(--text); font-family: 'Pretendard', sans-serif; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .container { width: 1000px; display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
        
        /* í”Œë ˆì´ì–´ ë¦¬ìŠ¤íŠ¸ */
        .player-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .player-card { background: var(--card-bg); padding: 15px; border-radius: 10px; text-align: center; border: 2px solid transparent; transition: 0.3s; position: relative; }
        .player-card.alive { cursor: pointer; }
        .player-card.dead { opacity: 0.5; background: #111; text-decoration: line-through; }
        .player-card.selected { border-color: var(--accent); transform: translateY(-5px); }
        .role-tag { font-size: 12px; padding: 2px 6px; border-radius: 4px; background: #444; margin-top: 5px; display: inline-block; }

        /* ì±„íŒ… ë¡œê·¸ */
        .sidebar { display: flex; flex-direction: column; gap: 15px; }
        #log { background: #000; height: 500px; padding: 15px; border-radius: 10px; overflow-y: auto; font-size: 14px; line-height: 1.6; border: 1px solid #333; display: flex; flex-direction: column; gap: 8px; }
        .msg { border-radius: 5px; padding: 5px 10px; max-width: 90%; }
        .msg.system { background: #333; color: #aaa; align-self: center; font-size: 12px; }
        .msg.ai { background: #2c3e50; align-self: flex-start; border-left: 3px solid var(--chat-ai); }
        .msg.me { background: #3e3e2c; align-self: flex-end; border-right: 3px solid var(--chat-me); }
        .msg b { color: #fff; }

        .controls { background: var(--card-bg); padding: 20px; border-radius: 10px; text-align: center; }
        button { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 5px; }
        button:disabled { background: #555; cursor: not-allowed; }

        .phase-indicator { font-size: 24px; font-weight: bold; margin-bottom: 10px; color: var(--accent); text-align: center; }
        .night { color: #9b59b6; }
    </style>
</head>
<body>

<div class="container">
    <div class="main-panel">
        <div id="phase-text" class="phase-indicator">ê²Œì„ ì‹œì‘ ëŒ€ê¸° ì¤‘</div>
        <div class="player-grid" id="player-grid"></div>
    </div>

    <div class="sidebar">
        <div id="log"></div>
        <div class="controls">
            <div id="instruction" style="margin-bottom: 10px;">í™˜ì˜í•©ë‹ˆë‹¤!</div>
            <button id="action-btn" onclick="initGame()">ê²Œì„ ì‹œì‘</button>
        </div>
    </div>
</div>

<script>
    const ROLES = { MAFIA: 'ë§ˆí”¼ì•„', POLICE: 'ê²½ì°°', DOCTOR: 'ì˜ì‚¬', CITIZEN: 'ì‹œë¯¼' };
    const PHASES = { READY: 0, NIGHT: 1, DAY_CHAT: 2, DAY_VOTE: 3 };
    
    let players = [];
    let currentPhase = PHASES.READY;
    let myIndex = 0;
    let selectedPlayer = null;
    let dayCount = 1;
    let chatTimers = [];

    const logEl = document.getElementById('log');
    const phaseEl = document.getElementById('phase-text');
    const instructionEl = document.getElementById('instruction');
    const actionBtn = document.getElementById('action-btn');

    // ì±„íŒ… ê´€ë ¨ ë¬¸êµ¬ í’€
    const chatPool = [
        "ëˆ„ê°€ ë§ˆí”¼ì•„ì§€? ì§„ì§œ ëª¨ë¥´ê² ë„¤.",
        "ì „ ê·¸ëƒ¥ ì„ ëŸ‰í•œ ì‹œë¯¼ì…ë‹ˆë‹¤. ì§„ì§œë¡œìš”.",
        "ê²½ì°°ë¶„ë“¤ ì¡°ì‚¬ ê²°ê³¼ ë‚˜ì˜¨ ê±° ì—†ë‚˜ìš”?",
        "ë°©ê¸ˆ ì£½ì€ ì‚¬ëŒ ë³´ë‹ˆê¹Œ ë§ˆí”¼ì•„ê°€ ë…¸ë ¨í•œë°?",
        "ì €ëŠ” ì™ ì§€ [TARGET]ë²ˆì´ ìˆ˜ìƒí•´ ë³´ì—¬ìš”.",
        "[TARGET]ë²ˆ, ì™œ ì•„ë¬´ ë§ì´ ì—†ìœ¼ì„¸ìš”?",
        "ì „ ì´ë²ˆì— ë¬´ì¡°ê±´ [TARGET]ë²ˆ íˆ¬í‘œí•˜ê² ìŠµë‹ˆë‹¤.",
        "ì•„ë‹ˆì—ìš”, ì „ ì‹œë¯¼ì´ë¼ë‹ˆê¹Œìš”!",
        "ì˜ì‚¬ë‹˜ ì € ì¢€ ì‚´ë ¤ì£¼ì„¸ìš”. ë¬´ì„œì›Œìš”.",
        "ì§€ê¸ˆ ì¡°ìš©íˆ ìˆëŠ” ì‚¬ëŒì´ ë²”ì¸ ì•„ë‹ê¹Œìš”?"
    ];

    function addLog(msg, type = 'system', sender = '') {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        if (sender) {
            div.innerHTML = `<b>[${sender}]</b>: ${msg}`;
        } else {
            div.innerHTML = msg;
        }
        logEl.appendChild(div);
        logEl.scrollTop = logEl.scrollHeight;
    }

    function initGame() {
        chatTimers.forEach(t => clearTimeout(t));
        const rolePool = [ROLES.MAFIA, ROLES.POLICE, ROLES.DOCTOR, ROLES.CITIZEN, ROLES.CITIZEN, ROLES.CITIZEN];
        const shuffled = rolePool.sort(() => Math.random() - 0.5);
        
        players = shuffled.map((role, i) => ({
            id: i + 1,
            role: role,
            isAlive: true,
            isAI: i !== 0,
            name: i === 0 ? "ë‚˜" : `í”Œë ˆì´ì–´ ${i + 1}`
        }));

        currentPhase = PHASES.READY;
        dayCount = 1;
        logEl.innerHTML = '';
        addLog("ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! ë‹¹ì‹ ì˜ ì§ì—…ì€ <b>[" + players[myIndex].role + "]</b>ì…ë‹ˆë‹¤.", "system");
        
        startNight();
    }

    function renderPlayers() {
        const grid = document.getElementById('player-grid');
        grid.innerHTML = '';
        players.forEach((p, i) => {
            const card = document.createElement('div');
            card.className = `player-card ${p.isAlive ? 'alive' : 'dead'} ${selectedPlayer === i ? 'selected' : ''}`;
            let roleInfo = (i === myIndex || !p.isAlive) ? `<div class="role-tag">${p.role}</div>` : '';
            card.innerHTML = `<div style="font-size: 40px">${p.isAlive ? 'ğŸ‘¤' : 'ğŸ’€'}</div><div>${p.name}</div>${roleInfo}`;
            if (p.isAlive && currentPhase !== PHASES.READY) card.onclick = () => selectPlayer(i);
            grid.appendChild(card);
        });
    }

    function selectPlayer(index) {
        if (!players[index].isAlive) return;
        selectedPlayer = index;
        renderPlayers();
    }

    // --- ë°¤ í˜ì´ì¦ˆ ---
    function startNight() {
        currentPhase = PHASES.NIGHT;
        selectedPlayer = null;
        phaseEl.innerText = `ì œ ${dayCount}ì¼ - ë°¤`;
        phaseEl.className = "phase-indicator night";
        renderPlayers();

        if (!players[myIndex].isAlive) {
            addLog("ë‹¹ì‹ ì€ ì‚¬ë§í–ˆìŠµë‹ˆë‹¤. ìƒí™©ì„ ì§€ì¼œë´…ë‹ˆë‹¤.");
            setTimeout(processNight, 2000);
            return;
        }

        instructionEl.innerText = `${players[myIndex].role}ì˜ ëŠ¥ë ¥ì„ ì‚¬ìš©í•˜ì„¸ìš”.`;
        actionBtn.disabled = false;
        actionBtn.innerText = (players[myIndex].role === ROLES.CITIZEN) ? "ë°¤ ë„˜ê¸°ê¸°" : "ëŠ¥ë ¥ ì‚¬ìš©";
        actionBtn.onclick = useAbility;
    }

    function useAbility() {
        if (players[myIndex].role !== ROLES.CITIZEN && selectedPlayer === null) {
            alert("ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”!"); return;
        }
        processNight();
    }

    function processNight() {
        let mafiaTarget = -1, doctorTarget = -1, policeTarget = -1;
        players.forEach((p, i) => {
            if (!p.isAlive) return;
            const aliveOthers = players.map((_, idx) => idx).filter(idx => players[idx].isAlive && idx !== i);
            const randomTarget = aliveOthers[Math.floor(Math.random() * aliveOthers.length)];

            if (p.role === ROLES.MAFIA) mafiaTarget = p.isAI ? randomTarget : selectedPlayer;
            if (p.role === ROLES.DOCTOR) doctorTarget = p.isAI ? randomTarget : selectedPlayer;
            if (p.role === ROLES.POLICE) policeTarget = p.isAI ? randomTarget : selectedPlayer;
        });

        if (players[myIndex].role === ROLES.POLICE && players[myIndex].isAlive) {
            const isMafia = players[policeTarget].role === ROLES.MAFIA;
            addLog(`ê²½ì°° ì¡°ì‚¬ ê²°ê³¼: ${players[policeTarget].name}ì€(ëŠ”) <b>${isMafia ? 'ë§ˆí”¼ì•„' : 'ì‹œë¯¼'}</b>ì…ë‹ˆë‹¤.`);
        }

        let deadPlayer = (mafiaTarget !== -1 && mafiaTarget !== doctorTarget) ? mafiaTarget : -1;
        if (deadPlayer !== -1) players[deadPlayer].isAlive = false;

        startDay(deadPlayer);
    }

    // --- ë‚® í˜ì´ì¦ˆ (ì±„íŒ… í¬í•¨) ---
    function startDay(deadIdx) {
        currentPhase = PHASES.DAY_CHAT;
        phaseEl.innerText = `ì œ ${dayCount}ì¼ - ë‚® (í† ë¡ )`;
        phaseEl.className = "phase-indicator";
        renderPlayers();

        addLog(`--- ì œ ${dayCount}ì¼ ë‚®ì´ ë°ì•˜ìŠµë‹ˆë‹¤ ---`, "system");
        if (deadIdx === -1) addLog("ì§€ë‚œë°¤ì—” ì•„ë¬´ ì¼ë„ ì—†ì—ˆìŠµë‹ˆë‹¤.");
        else addLog(`ì§€ë‚œë°¤ <b>${players[deadIdx].name}</b>ì´(ê°€) ì‚´í•´ë‹¹í–ˆìŠµë‹ˆë‹¤.`, "system");

        if (checkGameOver()) return;

        instructionEl.innerText = "AIë“¤ì´ í† ë¡  ì¤‘ì…ë‹ˆë‹¤...";
        actionBtn.disabled = true;
        actionBtn.innerText = "í† ë¡  ëŒ€ê¸° ì¤‘";

        // AI ê°€ì§œ ì±„íŒ… ìƒì„±
        generateAIChats();
    }

    function generateAIChats() {
        const aliveAIs = players.filter(p => p.isAlive && p.isAI);
        const chatCount = 4 + Math.floor(Math.random() * 3); // 4~6ê°œì˜ ì±„íŒ… ìƒì„±

        for (let i = 0; i < chatCount; i++) {
            const timer = setTimeout(() => {
                const talker = aliveAIs[Math.floor(Math.random() * aliveAIs.length)];
                if (!talker || currentPhase !== PHASES.DAY_CHAT) return;

                let msg = chatPool[Math.floor(Math.random() * chatPool.length)];
                const aliveOthers = players.filter(p => p.isAlive && p.name !== talker.name);
                const target = aliveOthers[Math.floor(Math.random() * aliveOthers.length)];
                msg = msg.replace("[TARGET]", target.id);

                addLog(msg, "ai", talker.name);

                if (i === chatCount - 1) {
                    instructionEl.innerText = "í† ë¡  ì¢…ë£Œ. íˆ¬í‘œë¥¼ ì‹œì‘í•˜ì„¸ìš”.";
                    actionBtn.disabled = false;
                    actionBtn.innerText = "íˆ¬í‘œí•˜ê¸°";
                    actionBtn.onclick = startVoting;
                }
            }, (i + 1) * 1500); // 1.5ì´ˆ ê°„ê²©ìœ¼ë¡œ ì±„íŒ…
            chatTimers.push(timer);
        }
    }

    function startVoting() {
        currentPhase = PHASES.DAY_VOTE;
        selectedPlayer = null;
        renderPlayers();
        addLog("íˆ¬í‘œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.", "system");
        instructionEl.innerText = "ë§ˆí”¼ì•„ë¥¼ ê³¨ë¼ íˆ¬í‘œí•˜ì„¸ìš”.";
        actionBtn.onclick = processVote;
    }

    function processVote() {
        if (players[myIndex].isAlive && selectedPlayer === null) {
            alert("íˆ¬í‘œ ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”!"); return;
        }

        let votes = new Array(players.length).fill(0);
        players.forEach((p, i) => {
            if (!p.isAlive) return;
            let target;
            if (p.isAI) {
                const aliveOnes = players.map((p, idx) => p.isAlive ? idx : -1).filter(idx => idx !== -1);
                target = aliveOnes[Math.floor(Math.random() * aliveOnes.length)];
            } else target = selectedPlayer;
            votes[target]++;
        });

        let maxVote = Math.max(...votes);
        let candidates = votes.map((v, i) => v === maxVote ? i : -1).filter(i => i !== -1);
        
        if (candidates.length > 1) addLog("ë™ì ìê°€ ë°œìƒí•˜ì—¬ ì•„ë¬´ë„ ì²˜í˜•ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        else {
            let executed = candidates[0];
            players[executed].isAlive = false;
            addLog(`íˆ¬í‘œ ê²°ê³¼ <b>${players[executed].name}</b> ì²˜í˜•. ì •ì²´ëŠ” [${players[executed].role}]!`);
        }

        renderPlayers();
        if (checkGameOver()) return;

        dayCount++;
        actionBtn.innerText = "ë°¤ìœ¼ë¡œ ê°€ê¸°";
        actionBtn.onclick = startNight;
    }

    function checkGameOver() {
        const mafiaCount = players.filter(p => p.isAlive && p.role === ROLES.MAFIA).length;
        const citizenCount = players.filter(p => p.isAlive && p.role !== ROLES.MAFIA).length;

        if (mafiaCount === 0) { endGame("ì‹œë¯¼ ìŠ¹ë¦¬!"); return true; }
        if (mafiaCount >= citizenCount) { endGame("ë§ˆí”¼ì•„ ìŠ¹ë¦¬!"); return true; }
        return false;
    }

    function endGame(msg) {
        currentPhase = PHASES.READY;
        phaseEl.innerText = "ê²Œì„ ì¢…ë£Œ";
        addLog(`ğŸ† ${msg}`, "system");
        instructionEl.innerText = "ë‹¤ì‹œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
        actionBtn.disabled = false;
        actionBtn.innerText = "ì¬ì‹œì‘";
        actionBtn.onclick = initGame;
        renderPlayers();
    }
</script>

</body>
</html>
