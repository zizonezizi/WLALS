<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI ë§ˆí”¼ì•„ PRO - ì‹¤ê°ë‚˜ëŠ” ì‹¬ë¦¬ì „</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #eee; --mafia: #ff4d4d; --police: #3498db; --doc: #2ecc71; --user: #f1c40f; }
        body { background: var(--bg); color: var(--text); font-family: 'Pretendard', sans-serif; margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        .game-wrapper { display: flex; width: 1100px; gap: 20px; padding: 20px; box-sizing: border-box; }
        
        /* ì™¼ìª½: í”Œë ˆì´ì–´ ì˜ì—­ */
        .main-panel { flex: 1; display: flex; flex-direction: column; gap: 20px; }
        .phase-header { background: var(--card); padding: 15px; border-radius: 12px; text-align: center; font-size: 22px; font-weight: bold; border-bottom: 4px solid var(--mafia); }
        .player-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .player-card { background: var(--card); padding: 15px; border-radius: 12px; text-align: center; border: 2px solid transparent; transition: 0.3s; position: relative; }
        .player-card.alive { cursor: pointer; border-color: #333; }
        .player-card.selected { border-color: var(--user); box-shadow: 0 0 15px var(--user); }
        .player-card.dead { opacity: 0.4; filter: grayscale(1); }
        .role-badge { font-size: 11px; padding: 3px 8px; border-radius: 20px; background: #444; margin-top: 8px; display: inline-block; }

        /* ì˜¤ë¥¸ìª½: ì±„íŒ… ë° ë¡œê·¸ ì˜ì—­ */
        .side-panel { width: 400px; display: flex; flex-direction: column; gap: 15px; }
        #chat-log { flex: 1; background: #000; border-radius: 12px; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; border: 1px solid #333; }
        
        .msg { padding: 8px 12px; border-radius: 8px; max-width: 85%; font-size: 14px; line-height: 1.5; }
        .msg.system { background: #222; color: #bbb; align-self: center; text-align: center; width: 90%; font-size: 12px; }
        .msg.ai { background: #2c3e50; align-self: flex-start; border-left: 4px solid var(--police); }
        .msg.me { background: #3e3e2c; align-self: flex-end; border-right: 4px solid var(--user); }
        .msg b { display: block; font-size: 11px; margin-bottom: 2px; color: #aaa; }

        .input-area { display: flex; gap: 8px; background: var(--card); padding: 10px; border-radius: 12px; }
        #chat-input { flex: 1; background: #000; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 6px; outline: none; }
        #send-btn { background: var(--user); color: #000; border: none; padding: 8px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; }

        .vote-summary { background: #222; border: 1px dashed #555; padding: 10px; border-radius: 8px; font-size: 13px; margin-top: 5px; color: #ffcc00; }
        
        button.action-btn { background: var(--mafia); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; }
        button:disabled { background: #444; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="game-wrapper">
    <div class="main-panel">
        <div id="phase-text" class="phase-header">ë§ˆí”¼ì•„ ê²Œì„ PRO</div>
        <div class="player-grid" id="player-grid"></div>
        <div id="vote-result-area"></div>
    </div>

    <div class="side-panel">
        <div id="chat-log"></div>
        <div class="input-area">
            <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="if(event.keyCode==13) sendMessage()">
            <button id="send-btn" onclick="sendMessage()">ì „ì†¡</button>
        </div>
        <button id="next-btn" class="action-btn" onclick="initGame()">ê²Œì„ ì‹œì‘</button>
    </div>
</div>

<script>
    const ROLES = { MAFIA: 'ë§ˆí”¼ì•„', POLICE: 'ê²½ì°°', DOCTOR: 'ì˜ì‚¬', CITIZEN: 'ì‹œë¯¼' };
    const PHASES = { READY: 0, NIGHT: 1, DAY_CHAT: 2, DAY_VOTE: 3 };
    
    let players = [];
    let currentPhase = PHASES.READY;
    let dayCount = 1;
    let selectedPlayer = null;
    let myIndex = 0;

    // AI ëŒ€ì‚¬ ë°ì´í„°
    const AI_PHRASES = {
        suspicion: ["ë²ˆì´ ì•„ê¹Œë¶€í„° ë„ˆë¬´ ì¡°ìš©í•œë°?", "ë²ˆ ë§ˆí”¼ì•„ ê°™ì§€ ì•ŠìŒ?", "ë‚œ ë²ˆì´ ì œì¼ ì˜ì‹¬ìŠ¤ëŸ¬ì›Œ.", "ë²ˆ í–‰ë™ì´ ì¢€ ì´ìƒí•œë°?"],
        defense: ["ì € ì‹œë¯¼ì´ì—ìš” ì§„ì§œë¡œ!", "ì € ì£½ì´ë©´ ì‹œë¯¼ ì†í•´ì…ë‹ˆë‹¤.", "ì•„ë‹ˆ ì™œ ì €ë¥¼ ì˜ì‹¬í•˜ì‹œì£ ?", "ì§„ì§œ ì–µìš¸í•´ìš”..."],
        policeClaim: ["ì € ê²½ì°°ì¸ë° ë²ˆ ì¡°ì‚¬í•˜ë‹ˆê¹Œ ë§ˆí”¼ì•„ ëœ¸!", "ì € ê²½ì°°ì„. ë²ˆ ì‹œë¯¼ì…ë‹ˆë‹¤.", "ê²½ì°° ì¡°ì‚¬ ê²°ê³¼ ê¸°ë‹¤ë ¤ë³´ì£ ."],
        agree: ["ì˜¤, ê·¸ëŸ´ë“¯í•œë°?", "ì¸ì •. ë²ˆ íˆ¬í‘œí•©ì‹œë‹¤.", "ì €ë„ ë²ˆì´ ì˜ì‹¬ë˜ê¸´ í–ˆì–´ìš”."]
    };

    function addMsg(text, type = 'system', sender = '') {
        const log = document.getElementById('chat-log');
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        if(sender) div.innerHTML = `<b>${sender}</b>${text}`;
        else div.innerHTML = text;
        log.appendChild(div);
        log.scrollTop = log.scrollHeight;
    }

    function initGame() {
        const rolePool = [ROLES.MAFIA, ROLES.POLICE, ROLES.DOCTOR, ROLES.CITIZEN, ROLES.CITIZEN, ROLES.CITIZEN].sort(() => Math.random() - 0.5);
        players = rolePool.map((role, i) => ({
            id: i + 1, name: i === 0 ? "ë‚˜" : `í”Œë ˆì´ì–´ ${i + 1}`,
            role: role, isAlive: true, isAI: i !== 0
        }));
        dayCount = 1;
        document.getElementById('chat-log').innerHTML = '';
        document.getElementById('vote-result-area').innerHTML = '';
        addMsg(`ê²Œì„ ì‹œì‘! ë‹¹ì‹ ì˜ ì§ì—…ì€ [${players[myIndex].role}]ì…ë‹ˆë‹¤.`, 'system');
        startNight();
    }

    function render() {
        const grid = document.getElementById('player-grid');
        grid.innerHTML = '';
        players.forEach((p, i) => {
            const card = document.createElement('div');
            card.className = `player-card ${p.isAlive ? 'alive' : 'dead'} ${selectedPlayer === i ? 'selected' : ''}`;
            let info = (i === myIndex || !p.isAlive) ? `<div class="role-badge">${p.role}</div>` : '';
            card.innerHTML = `<div style="font-size:30px">${p.isAlive?'ğŸ‘¤':'ğŸ’€'}</div><b>${p.name}</b>${info}`;
            if(p.isAlive && currentPhase !== PHASES.READY) card.onclick = () => { selectedPlayer = i; render(); };
            grid.appendChild(card);
        });
    }

    function startNight() {
        currentPhase = PHASES.NIGHT;
        selectedPlayer = null;
        document.getElementById('phase-text').innerText = `ì œ ${dayCount}ì¼ - ë°¤`;
        document.getElementById('chat-input').disabled = true;
        render();
        
        const btn = document.getElementById('next-btn');
        btn.innerText = players[myIndex].role === ROLES.CITIZEN ? "ë°¤ ë„˜ê¸°ê¸°" : "ëŠ¥ë ¥ ì‚¬ìš©";
        btn.onclick = processNight;
    }

    function processNight() {
        if(players[myIndex].isAlive && players[myIndex].role !== ROLES.CITIZEN && selectedPlayer === null) {
            alert("ëŠ¥ë ¥ì„ ì‚¬ìš©í•  ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”!"); return;
        }

        let mafiaTarget = -1, doctorTarget = -1, policeTarget = -1;
        players.forEach((p, i) => {
            if(!p.isAlive) return;
            const targets = players.map((_,idx)=>idx).filter(idx => players[idx].isAlive && idx !== i);
            const rnd = targets[Math.floor(Math.random()*targets.length)];

            if(p.role === ROLES.MAFIA) mafiaTarget = p.isAI ? rnd : selectedPlayer;
            if(p.role === ROLES.DOCTOR) doctorTarget = p.isAI ? rnd : selectedPlayer;
            if(p.role === ROLES.POLICE) policeTarget = p.isAI ? rnd : selectedPlayer;
        });

        if(players[myIndex].role === ROLES.POLICE && players[myIndex].isAlive) {
            const isM = players[policeTarget].role === ROLES.MAFIA;
            addMsg(`${players[policeTarget].name}ì€(ëŠ”) [${isM?'ë§ˆí”¼ì•„':'ì‹œë¯¼'}]ì…ë‹ˆë‹¤.`, 'system');
        }

        let dead = (mafiaTarget !== -1 && mafiaTarget !== doctorTarget) ? mafiaTarget : -1;
        if(dead !== -1) players[dead].isAlive = false;

        startDay(dead);
    }

    function startDay(deadIdx) {
        currentPhase = PHASES.DAY_CHAT;
        document.getElementById('phase-text').innerText = `ì œ ${dayCount}ì¼ - ë‚® (í† ë¡ )`;
        document.getElementById('chat-input').disabled = false;
        document.getElementById('vote-result-area').innerHTML = '';
        render();

        addMsg(`--- ì œ ${dayCount}ì¼ ë‚®ì´ ë°ì•˜ìŠµë‹ˆë‹¤ ---`, 'system');
        addMsg(deadIdx === -1 ? "ì§€ë‚œë°¤ì—” ì•„ë¬´ë„ ì£½ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤." : `ì§€ë‚œë°¤ [${players[deadIdx].name}]ì´ ì‚´í•´ë‹¹í–ˆìŠµë‹ˆë‹¤.`, 'system');

        if(checkEnd()) return;

        const btn = document.getElementById('next-btn');
        btn.innerText = "íˆ¬í‘œ ì‹œì‘";
        btn.onclick = startVote;

        // AI ìë™ ì±„íŒ… ì‹œì‘
        let chatCount = 0;
        const interval = setInterval(() => {
            if(currentPhase !== PHASES.DAY_CHAT || chatCount > 3) { clearInterval(interval); return; }
            aiTalk();
            chatCount++;
        }, 3000);
    }

    function aiTalk(forceTarget = null, forceType = null) {
        const aliveAIs = players.filter(p => p.isAlive && p.isAI);
        if(aliveAIs.length === 0) return;
        const talker = aliveAIs[Math.floor(Math.random()*aliveAIs.length)];
        
        let type = forceType || (Math.random() > 0.7 ? 'defense' : 'suspicion');
        let msg = AI_PH
