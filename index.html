<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI ë§ˆí”¼ì•„ PRO - ì±„íŒ… ì—ë””ì…˜</title>
    <style>
        :root {
            --bg: #121212; --card: #1e1e1e; --text: #eee;
            --mafia: #ff4d4d; --police: #3498db; --doc: #2ecc71;
            --user: #f1c40f; --system: #555;
        }

        body {
            background: var(--bg); color: var(--text);
            font-family: 'Pretendard', -apple-system, sans-serif;
            margin: 0; display: flex; justify-content: center; align-items: center;
            height: 100vh; overflow: hidden;
        }

        .game-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            width: 1200px; height: 850px;
            gap: 20px; padding: 20px;
        }

        /* ì™¼ìª½: í”Œë ˆì´ì–´ ê´€ë¦¬ ë° ìƒíƒœ */
        .left-panel {
            display: flex; flex-direction: column; gap: 20px;
        }

        .phase-box {
            background: var(--card); padding: 20px; border-radius: 15px;
            text-align: center; border-bottom: 5px solid var(--mafia);
        }

        .player-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
        }

        .player-card {
            background: var(--card); padding: 15px; border-radius: 12px;
            text-align: center; border: 2px solid transparent; transition: 0.3s;
            cursor: pointer; position: relative;
        }

        .player-card.alive:hover { border-color: #555; }
        .player-card.selected { border-color: var(--user); box-shadow: 0 0 10px var(--user); }
        .player-card.dead { opacity: 0.3; filter: grayscale(1); cursor: default; }
        .role-tag {
            font-size: 11px; padding: 2px 8px; border-radius: 10px;
            background: #444; margin-top: 5px; display: inline-block;
        }

        /* ì˜¤ë¥¸ìª½: ì±„íŒ…ì°½ ì „ìš© êµ¬ì—­ */
        .chat-area {
            display: flex; flex-direction: column;
            background: #181818; border-radius: 20px;
            border: 1px solid #333; overflow: hidden;
        }

        .chat-header {
            padding: 15px 20px; background: #222; border-bottom: 1px solid #333;
            font-weight: bold; display: flex; justify-content: space-between;
        }

        #chat-messages {
            flex: 1; padding: 20px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 12px;
        }

        /* ì±„íŒ… ë§í’ì„  ìŠ¤íƒ€ì¼ */
        .msg { max-width: 70%; padding: 10px 15px; border-radius: 15px; font-size: 14px; line-height: 1.5; position: relative; }
        .msg b { display: block; font-size: 11px; margin-bottom: 4px; opacity: 0.7; }

        .msg.ai { align-self: flex-start; background: #2c2c2c; border-bottom-left-radius: 2px; }
        .msg.me { align-self: flex-end; background: #3d3d2a; border-bottom-right-radius: 2px; border-right: 3px solid var(--user); }
        .msg.system {
            align-self: center; background: rgba(255,255,255,0.05);
            color: #999; border-radius: 5px; font-size: 12px; max-width: 90%; text-align: center;
        }

        /* íˆ¬í‘œ ê²°ê³¼ ì „ìš© ìŠ¤íƒ€ì¼ */
        .vote-card {
            background: rgba(241, 196, 15, 0.1); border: 1px solid var(--user);
            padding: 10px; border-radius: 10px; margin: 10px 0; font-size: 13px;
        }

        /* í•˜ë‹¨ ì…ë ¥ë°” */
        .chat-input-bar {
            padding: 20px; background: #222; display: flex; gap: 10px;
        }

        #user-input {
            flex: 1; background: #000; border: 1px solid #444; color: #fff;
            padding: 12px; border-radius: 8px; outline: none;
        }

        .action-btn {
            background: var(--mafia); color: white; border: none;
            padding: 0 25px; border-radius: 8px; font-weight: bold; cursor: pointer;
        }

        .action-btn:disabled { background: #444; cursor: not-allowed; }

    </style>
</head>
<body>

<div class="game-container">
    <div class="left-panel">
        <div class="phase-box">
            <div id="day-text" style="font-size: 14px; color: #aaa;">WELCOME</div>
            <div id="phase-text" style="font-size: 24px;">ë§ˆí”¼ì•„ PRO</div>
        </div>

        <div class="player-grid" id="player-grid">
            </div>

        <div style="margin-top: auto;">
            <button id="main-action-btn" class="action-btn" style="width: 100%; height: 60px;" onclick="gameController()">ê²Œì„ ì‹œì‘</button>
        </div>
    </div>

    <div class="chat-area">
        <div class="chat-header">
            <span>ì‹¤ì‹œê°„ ëŒ€í™”ì°½</span>
            <span id="status-tag" style="color: var(--user);">ëŒ€ê¸° ì¤‘</span>
        </div>
        <div id="chat-messages">
            <div class="msg system">ë§ˆí”¼ì•„ ê²Œì„ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.<br>í•˜ë‹¨ì˜ ê²Œì„ ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
        </div>
        <div class="chat-input-bar">
            <input type="text" id="user-input" placeholder="AIë“¤ê³¼ ëŒ€í™”í•˜ì„¸ìš”..." onkeypress="if(event.keyCode==13) sendChat()" disabled>
            <button id="send-btn" class="action-btn" style="background: var(--user); color: #000;" onclick="sendChat()" disabled>ì „ì†¡</button>
        </div>
    </div>
</div>

<script>
    const ROLES = { MAFIA: 'ë§ˆí”¼ì•„', POLICE: 'ê²½ì°°', DOCTOR: 'ì˜ì‚¬', CITIZEN: 'ì‹œë¯¼' };
    const PHASES = { READY: 0, NIGHT: 1, DAY_CHAT: 2, DAY_VOTE: 3 };

    let players = [];
    let currentPhase = PHASES.READY;
    let dayCount = 1;
    let selectedIdx = null;
    let myIdx = 0;

    // AI ì„±ê²©ë³„ ëŒ€ì‚¬ í’€
    const AI_REACTIONS = {
        suspicion: ["ë²ˆë‹˜ ì•„ê¹Œë¶€í„° ì¡°ìš©í•˜ì‹  ê²Œ ë”± ë§ˆí”¼ì•„ ê´€ìƒì´ë„¤ìš”.", "ë²ˆë‹˜, ì‹œë¯¼ì´ë¼ë©´ì„œìš”? ì¦ëª…í•´ë´ìš”.", "ì „ ë¬´ì¡°ê±´ ë²ˆë‹˜ ì°ìŠµë‹ˆë‹¤. ìˆ˜ìƒí•´ìš”."],
        defense: ["ì™€... ì € ì§„ì§œ ì‹œë¯¼ì¸ë° ë„ˆë¬´í•˜ì‹œë„¤.", "ì € ì£½ìœ¼ë©´ ë§ˆí”¼ì•„ë“¤ë§Œ ì¢‹ì•„í•  ê±¸ìš”?", "ì•„ë‹ˆ, ì „ ê·¸ëƒ¥ ì¡°ìš©íˆ ìƒí™© ë³´ëŠ” ì¤‘ì´ì—ˆë‹¤ê³ ìš”."],
        police: ["ì € ì‚¬ì‹¤ ê²½ì°°ì…ë‹ˆë‹¤. ë²ˆ ì¡°ì‚¬í•´ë´¤ëŠ”ë° ë§ˆí”¼ì•„ ë§ì•„ìš”.", "ê²½ì°° ì—¬ê¸° ìˆì–´ìš”! ë²ˆë‹˜ì€ í™•ì‹¤íˆ ì‹œë¯¼ì…ë‹ˆë‹¤."],
        etc: ["ì´ë²ˆì—” ë¬´ì¡°ê±´ ì¡ì•„ì•¼ í•˜ëŠ”ë°...", "ë‹¤ë“¤ ë²ˆë‹˜ ë§ ë¯¿ìœ¼ì„¸ìš”?", "ë§ˆí”¼ì•„ ì§„ì§œ ë…¸ë ¨í•˜ë„¤."]
    };

    function addChat(text, type, sender = "") {
        const chatBox = document.getElementById('chat-messages');
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        
        if (type === 'system') {
            div.innerHTML = text;
        } else {
            div.innerHTML = `<b>${sender}</b> ${text}`;
        }
        
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function initGame() {
        const pool = [ROLES.MAFIA, ROLES.POLICE, ROLES.DOCTOR, ROLES.CITIZEN, ROLES.CITIZEN, ROLES.CITIZEN].sort(() => Math.random() - 0.5);
        players = pool.map((role, i) => ({
            id: i + 1, name: i === 0 ? "ë‹¹ì‹ " : `í”Œë ˆì´ì–´ ${i + 1}`,
            role, isAlive: true, isAI: i !== 0
        }));
        
        dayCount = 1;
        document.getElementById('chat-messages').innerHTML = '';
        addChat(`ê²Œì„ì„ ì‹œì‘í•©ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ì§ì—…ì€ [${players[myIdx].role}]ì…ë‹ˆë‹¤.`, 'system');
        startNight();
    }

    function renderPlayers() {
        const grid = document.getElementById('player-grid');
        grid.innerHTML = '';
        players.forEach((p, i) => {
            const card = document.createElement('div');
            card.className = `player-card ${p.isAlive ? 'alive' : 'dead'} ${selectedIdx === i ? 'selected' : ''}`;
            let roleInfo = (i === myIdx || !p.isAlive) ? `<div class="role-tag">${p.role}</div>` : '';
            card.innerHTML = `<div style="font-size:35px">${p.isAlive ? 'ğŸ‘¤' : 'ğŸ’€'}</div><b>${p.name}</b><br>${roleInfo}`;
            
            if (p.isAlive && currentPhase !== PHASES.READY) {
                card.onclick = () => { selectedIdx = i; renderPlayers(); };
            }
            grid.appendChild(card);
        });
    }

    function gameController() {
        if (currentPhase === PHASES.READY) initGame();
        else if (currentPhase === PHASES.NIGHT) processNight();
        else if (currentPhase === PHASES.DAY_CHAT) startVotingPhase();
        else if (currentPhase === PHASES.DAY_VOTE) processVote();
    }

    // --- ë°¤ ---
    function startNight() {
        currentPhase = PHASES.NIGHT;
        selectedIdx = null;
        renderPlayers();
        document.getElementById('day-text').innerText = `DAY ${dayCount}`;
        document.getElementById('phase-text').innerText = `ê¹Šì€ ë°¤`;
        document.getElementById('status-tag').innerText = "ëŠ¥ë ¥ ì‚¬ìš© ì¤‘";
        document.getElementById('user-input').disabled = true;
        document.getElementById('send-btn').disabled = true;

        const btn = document.getElementById('main-action-btn');
        btn.innerText = players[myIdx].role === ROLES.CITIZEN ? "ë°¤ ì§€ìƒˆìš°ê¸°" : "ëŠ¥ë ¥ ì‚¬ìš©";
        addChat("ë°¤ì´ ë˜ì—ˆìŠµë‹ˆë‹¤. ë§ˆí”¼ì•„ì™€ íŠ¹ìˆ˜ ì§ì—…ë“¤ì´ í™œë™í•©ë‹ˆë‹¤.", "system");
    }

    function processNight() {
        if (players[myIdx].isAlive && players[myIdx].role !== ROLES.CITIZEN && selectedIdx === null) {
            alert("ëŒ€ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”!"); return;
        }

        let targets = { mafia: -1, doctor: -1, police: -1 };
        players.forEach((p, i) => {
            if (!p.isAlive) return;
            const rndTarget = () => {
                const alive = players.map((_, idx) => idx).filter(idx => players[idx].isAlive && idx !== i);
                return alive[Math.floor(Math.random() * alive.length)];
            };

            if (p.role === ROLES.MAFIA) targets.mafia = p.isAI ? rndTarget() : selectedIdx;
            if (p.role === ROLES.DOCTOR) targets.doctor = p.isAI ? rndTarget() : selectedIdx;
            if (p.role === ROLES.POLICE) targets.police = p.isAI ? rndTarget() : selectedIdx;
        });

        // ê²½ì°° ì¡°ì‚¬ ê²°ê³¼
        if (players[myIdx].role === ROLES.POLICE && players[myIdx].isAlive) {
            const isM = players[targets.police].role === ROLES.MAFIA;
            addChat(`[ê²½ì°° ê²°ê³¼] ${players[targets.police].name}ë‹˜ì€ ${isM ? 'ë§ˆí”¼ì•„' : 'ì‹œë¯¼'}ì…ë‹ˆë‹¤.`, 'system');
        }

        let killed = (targets.mafia !== -1 && targets.mafia !== targets.doctor) ? targets.mafia : -1;
        if (killed !== -1) players[killed].isAlive = false;

        startDay(killed);
    }

    // --- ë‚® ---
    function startDay(killedIdx) {
        currentPhase = PHASES.DAY_CHAT;
        document.getElementById('phase-text').innerText = `í™”ì°½í•œ ë‚®`;
        document.getElementById('status-tag').innerText = "í† ë¡  ì‹œê°„";
        document.getElementById('user-input').disabled = false;
        document.getElementById('send-btn').disabled = false;
        renderPlayers();

        addChat(`--- ì œ ${dayCount}ì¼ ë‚®ì´ ë°ì•˜ìŠµë‹ˆë‹¤ ---`, 'system');
        if (killedIdx === -1) addChat("ì–´ì ¯ë°¤ì—” í‰í™”ë¡œì› ìŠµë‹ˆë‹¤. ì•„ë¬´ë„ ì£½ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", "system");
        else addChat(`ì–´ì ¯ë°¤ [${players[killedIdx].name}]ë‹˜ì´ ë§ˆí”¼ì•„ì—ê²Œ ë‹¹í–ˆìŠµë‹ˆë‹¤.`, "system");

        if (checkVictory()) return;

        document.getElementById('main-action-btn').innerText = "íˆ¬í‘œ ì‹œì‘";
        
        // AI ì„ ì œ ê³µê²© ëŒ€í™”
        setTimeout(() => aiTalk(), 1500);
    }

    function aiTalk(keyword = "", targetId = null) {
        const aliveAIs = players.filter(p => p.isAI && p.isAlive);
        if (aliveAIs.length === 0) return;
        const talker = aliveAIs[Math.floor(Math.random() * aliveAIs.length)];
        
        let pool = AI_REACTIONS.suspicion;
        if (keyword === "defense") pool = AI_REACTIONS.defense;
        if (keyword === "police") pool = AI_REACTIONS.police;

        let msg = pool[Math.floor(Math.random() * pool.length)];
        let target = targetId || players.filter(p => p.isAlive && p.id !== talker.id)[Math.floor(Math.random() * 5)].id;
        
        addChat(msg.replace("ë²ˆ", `[${target}ë²ˆ]`), 'ai', talker.name);
    }

    function sendChat() {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if (!text || currentPhase !== PHASES.DAY_CHAT) return;

        addChat(text, 'me', "ë‚˜");
        input.value = '';

        // ì‚¬ìš©ìì˜ ëŒ€í™” ë‚´ìš©ì— ë”°ë¥¸ AI ë°˜ì‘ ë¡œì§
        setTimeout(() => {
            if (text.includes("ê²½ì°°")) aiTalk("police");
            else if (text.includes("ì•„ë‹ˆ") || text.includes("ì‹œë¯¼")) aiTalk("defense");
            else if (/\d/.test(text)) { // ìˆ«ìê°€ í¬í•¨ë˜ë©´ ì˜ì‹¬ìœ¼ë¡œ ê°„ì£¼
                const num = text.match(/\d/)[0];
                aiTalk("suspicion", num);
            } else {
                aiTalk();
            }
        }, 1200);
    }

    function startVotingPhase() {
        currentPhase = PHASES.DAY_VOTE;
        selectedIdx = null;
        renderPlayers();
        addChat("í† ë¡ ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë§ˆí”¼ì•„ë¡œ ì˜ì‹¬ë˜ëŠ” ì¸ë¬¼ì„ íˆ¬í‘œí•˜ì„¸ìš”.", "system");
        document.getElementById('status-tag').innerText = "íˆ¬í‘œ ì§„í–‰ ì¤‘";
        document.getElementById('main-action-btn').innerText = "íˆ¬í‘œ í™•ì •";
    }

    function processVote() {
        if (players[myIdx].isAlive && selectedIdx === null) {
            alert("íˆ¬í‘œí•  ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”!"); return;
        }

        let votes = new Array(players.length).fill(0);
        let details = [];

        players.forEach((p, i) => {
            if (!p.isAlive) return;
            let t;
            if (p.isAI) {
                const alive = players.map((_, idx) => idx).filter(idx => players[idx].isAlive);
                t = alive[Math.floor(Math.random() * alive.length)];
            } else t = selectedIdx;
            
            votes[t]++;
            details.push(`${p.name} â†’ ${players[t].name}`);
        });

        // íˆ¬í‘œ ê²°ê³¼ ì‹œê°í™”
        let resDiv = document.createElement('div');
        resDiv.className = 'vote-card';
        resDiv.innerHTML = `<b>ğŸ“Š íˆ¬í‘œ ì§‘ê³„ ê²°ê³¼</b><br>${details.join('<br>')}`;
        document.getElementById('chat-messages').appendChild(resDiv);

        let max = Math.max(...votes);
        let candidates = votes.map((v, i) => v === max ? i : -1).filter(i => i !== -1);

        if (candidates.length > 1) {
            addChat("ë™ì ìœ¼ë¡œ ì¸í•´ ì•„ë¬´ë„ ì²˜í˜•ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", "system");
        } else {
            let dead = candidates[0];
            players[dead].isAlive = false;
            addChat(`[${players[dead].name}]ë‹˜ì´ ë‹¤ìˆ˜ê²°ë¡œ ì²˜í˜•ë˜ì—ˆìŠµë‹ˆë‹¤. ì •ì²´ëŠ” [${players[dead].role}]ì˜€ìŠµë‹ˆë‹¤.`, "system");
        }

        renderPlayers();
        if (checkVictory()) return;

        dayCount++;
        document.getElementById('main-action-btn').innerText = "ë‹¤ìŒ ë°¤ìœ¼ë¡œ";
        document.getElementById('main-action-btn').onclick = startNight;
    }

    function checkVictory() {
        const mafia = players.filter(p => p.isAlive && p.role === ROLES.MAFIA).length;
        const citizen = players.filter(p => p.isAlive && p.role !== ROLES.MAFIA).length;

        if (mafia === 0) {
            endGame("ì‹œë¯¼ë“¤ì´ ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤! ë„ì‹œì˜ í‰í™”ê°€ ì°¾ì•„ì™”ìŠµë‹ˆë‹¤.");
            return true;
        }
        if (mafia >= citizen) {
            endGame("ë§ˆí”¼ì•„ê°€ ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤! ë„ì‹œê°€ ì–´ë‘ ì— ì ê¹ë‹ˆë‹¤.");
            return true;
        }
        return false;
    }

    function endGame(msg) {
        addChat(msg, "system");
        document.getElementById('phase-text').innerText = "ê²Œì„ ì¢…ë£Œ";
        document.getElementById('main-action-btn').innerText = "ìƒˆ ê²Œì„ ì‹œì‘";
        document.getElementById('main-action-btn').onclick = () => location.reload();
        currentPhase = PHASES.READY;
    }
</script>

</body>
</html>
